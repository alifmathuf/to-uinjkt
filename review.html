<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Review Jawaban - Tryout PPG</title>

<link rel="icon" type="image/svg+xml" href="assets/logo-uin.svg">
<link rel="shortcut icon" href="assets/logo-uin.svg">

<link rel="stylesheet" href="css/app.css">
<link rel="stylesheet" href="css/review.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase 8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDPUb6ILn9GwB7cg_GzLj5etbDNBJ6in3k",
  authDomain: "cbtuin-d26aa.firebaseapp.com",
  databaseURL: "https://cbtuin-d26aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cbtuin-d26aa",
  storageBucket: "cbtuin-d26aa.appspot.com",
  messagingSenderId: "93548126228",
  appId: "1:93548126228:web:c456aedaad373237a0c701"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
</script>
</head>

<body class="review-page">

<div class="review-container">
  
  <!-- Header -->
  <div class="review-header">
    <h2>üìã Review Jawaban Ujian</h2>
  </div>

  <!-- Scrollable Content -->
  <div class="review-scroll">
    <table class="review-table">
      <thead>
        <tr>
          <th class="col-no">No</th>
          <th class="col-soal">Soal</th>
          <th class="col-jawaban">Jawaban Anda</th>
          <th class="col-status">Status</th>
        </tr>
      </thead>
      <tbody id="reviewBody">
        <tr>
          <td colspan="4" class="loading-cell">Memuat data...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <div class="review-footer">
    <button onclick="window.location.href='dashboard.html'" class="btn-back">
      ‚Üê Kembali ke Dashboard
    </button>
    <button onclick="window.location.href='result.html'" class="btn-result">
      Lihat Hasil ‚Üí
    </button>
  </div>

</div>

<script src="js/auth.js"></script>
<script src="js/review.js"></script>

<script>
// Cek login
const user = firebase.auth().currentUser;
if (!user) {
  window.location.href = 'login.html';
} else {
  loadReviewData(user.uid);
}

function loadReviewData(userId) {
  const container = document.getElementById("reviewBody");
  
  database.ref(`exams/${userId}`)
    .orderByChild("submittedAt")
    .limitToLast(1)
    .once("value")
    .then(snapshot => {
      
      if (!snapshot.exists()) {
        container.innerHTML = `
          <tr>
            <td colspan="4" class="empty-cell">
              Belum ada data ujian.
            </td>
          </tr>`;
        return;
      }

      const examData = Object.values(snapshot.val())[0];
      const jawaban = examData.answers;
      const mapel = examData.mapel;
      const paket = examData.paket;

      fetch(`paket/${mapel}/${paket}.json`)
        .then(res => res.json())
        .then(soalData => {
          tampilkanReview(soalData.slice(0, jawaban.length), jawaban);
        })
        .catch(err => {
          console.error(err);
          container.innerHTML = `
            <tr>
              <td colspan="4" class="empty-cell">
                Gagal memuat soal.
              </td>
            </tr>`;
        });
    })
    .catch(err => {
      console.error(err);
      container.innerHTML = `
        <tr>
          <td colspan="4" class="empty-cell">
            Gagal memuat data.
          </td>
        </tr>`;
    });
}

function tampilkanReview(soal, jawaban) {
  const tbody = document.getElementById("reviewBody");
  tbody.innerHTML = "";

  soal.forEach((s, i) => {
    const userAnswerIndex = jawaban[i];
    const correctIndex = s.a;

    const userAnswerText = (userAnswerIndex !== null && userAnswerIndex !== undefined)
      ? s.o[userAnswerIndex]
      : "-";

    const isCorrect = userAnswerIndex === correctIndex;
    const statusIcon = isCorrect
      ? '<span class="status-benar">‚úì</span>'
      : '<span class="status-salah">‚úó</span>';

    // Batasi panjang soal
    let soalText = s.q;
    if (soalText.length > 120) {
      soalText = soalText.substring(0, 120) + "...";
    }

    const row = `
      <tr>
        <td class="cell-no">${i + 1}</td>
        <td class="cell-soal" title="${s.q}">${soalText}</td>
        <td class="cell-jawaban">${userAnswerText}</td>
        <td class="cell-status">${statusIcon}</td>
      </tr>
    `;

    tbody.innerHTML += row;
  });
}
</script>

</body>
</html>
